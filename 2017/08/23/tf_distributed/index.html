<!doctype html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />













<script>
  (function(){
    if (''){
      if (prompt('Please input reading password','') !== ''){
        alert('error password.');
        history.back();
        }
    }
  })();
</script>



  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="blog" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Easy demo12345678# Start a TensorFlow server as a single-process &quot;cluster&quot;.$ python&amp;gt;&amp;gt;&amp;gt; import tensorflow as tf&amp;gt;&amp;gt;&amp;gt; c = tf.constant(&quot;Hello, distributed TensorFlow!&quot;)&amp;gt;&amp;gt;&amp;gt; server">
<meta property="og:type" content="article">
<meta property="og:title" content="Klpek's Note Library">
<meta property="og:url" content="http://yoursite.com/2017/08/23/tf_distributed/index.html">
<meta property="og:site_name" content="Klpek's Note Library">
<meta property="og:description" content="Easy demo12345678# Start a TensorFlow server as a single-process &quot;cluster&quot;.$ python&amp;gt;&amp;gt;&amp;gt; import tensorflow as tf&amp;gt;&amp;gt;&amp;gt; c = tf.constant(&quot;Hello, distributed TensorFlow!&quot;)&amp;gt;&amp;gt;&amp;gt; server">
<meta property="og:updated_time" content="2017-08-23T13:39:04.031Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Klpek's Note Library">
<meta name="twitter:description" content="Easy demo12345678# Start a TensorFlow server as a single-process &quot;cluster&quot;.$ python&amp;gt;&amp;gt;&amp;gt; import tensorflow as tf&amp;gt;&amp;gt;&amp;gt; c = tf.constant(&quot;Hello, distributed TensorFlow!&quot;)&amp;gt;&amp;gt;&amp;gt; server">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/08/23/tf_distributed/"/>





  <title>  | Klpek's Note Library </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  














  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Klpek's Note Library</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/23/tf_distributed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Klpek">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Klpek's Note Library">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-23T21:39:04+08:00">
                2017-08-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/23/tf_distributed/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/08/23/tf_distributed/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="Easy-demo"><a href="#Easy-demo" class="headerlink" title="Easy demo"></a>Easy demo</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Start a TensorFlow server as a single-process "cluster".</span></div><div class="line">$ python</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>c = tf.constant(<span class="string">"Hello, distributed TensorFlow!"</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>server = tf.train.Server.create_local_server()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>sess = tf.Session(server.target)  <span class="comment"># Create a session on the server.</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>sess.run(c)</div><div class="line"><span class="string">'Hello, distributed TensorFlow!'</span></div></pre></td></tr></table></figure>
<p>The <code>tf.train.Server.create_local_server</code> method creates a single-process cluster, with an in-process server.</p>
<h3 id="Create-a-cluster"><a href="#Create-a-cluster" class="headerlink" title="Create a cluster"></a>Create a cluster</h3><h4 id="cluster"><a href="#cluster" class="headerlink" title="cluster"></a>cluster</h4><p>a set of “tasks” that participate in the distributed execution of a TensorFlow graph.</p>
<h6 id="task"><a href="#task" class="headerlink" title="task"></a>task</h6><p>Each task is associated with a TensorFlow “server”.</p>
<ul>
<li>which contains a “master” that can be used to create sessions, </li>
<li>and a “worker” that executes operations in the graph.</li>
</ul>
<h6 id="jobs"><a href="#jobs" class="headerlink" title="jobs"></a>jobs</h6><p>A cluster can also be divided into one or more “jobs”,</p>
<ul>
<li>where each job contains one or more tasks.</li>
</ul>
<h4 id="create-cluster"><a href="#create-cluster" class="headerlink" title="create cluster"></a>create cluster</h4><p>start one TensorFlow server per task in the cluster.<br>Each task typically runs on a different machine<br>but you can run multiple tasks on the same machine<br>In each task, do the following:</p>
<ol>
<li><strong>Create a</strong> <code>tf.train.ClusterSpec</code> that describes all of the tasks in the cluster. <ul>
<li>This should be the same for each task.</li>
</ul>
</li>
<li>Create a tf.train.Server<ul>
<li>passing the <code>tf.train.ClusterSpec</code> to the constructor,</li>
<li>identifying the local task with a job name and task index.</li>
</ul>
</li>
</ol>
<h5 id="Create-a-tf-train-ClusterSpec-to-describe-the-cluster"><a href="#Create-a-tf-train-ClusterSpec-to-describe-the-cluster" class="headerlink" title="Create a tf.train.ClusterSpec to describe the cluster"></a>Create a <code>tf.train.ClusterSpec</code> to describe the cluster</h5><p>The cluster specification dictionary maps job names to lists of network addresses.<br>Pass this dictionary to the tf.train.ClusterSpec constructor.</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tf.train.ClusterSpec(&#123;<span class="string">"local"</span>: [<span class="string">"localhost:2222"</span>, <span class="string">"localhost:2223"</span>]&#125;)</div></pre></td></tr></table></figure>
<p>/job:local/task:0<br>/job:local/task:1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">tf.train.ClusterSpec(&#123;</div><div class="line">    <span class="string">"worker"</span>: [</div><div class="line">        <span class="string">"worker0.example.com:2222"</span>,</div><div class="line">        <span class="string">"worker1.example.com:2222"</span>,</div><div class="line">        <span class="string">"worker2.example.com:2222"</span></div><div class="line">    ],</div><div class="line">    <span class="string">"ps"</span>: [</div><div class="line">        <span class="string">"ps0.example.com:2222"</span>,</div><div class="line">        <span class="string">"ps1.example.com:2222"</span></div><div class="line">    ]&#125;)</div></pre></td></tr></table></figure>
<p>/job:worker/task:0<br>/job:worker/task:1<br>/job:worker/task:2<br>/job:ps/task:0<br>/job:ps/task:1</p>
</blockquote>
<h5 id="Create-a-tf-train-Server-instance-in-each-task"><a href="#Create-a-tf-train-Server-instance-in-each-task" class="headerlink" title="Create a tf.train.Server instance in each task"></a>Create a tf.train.Server instance in each task</h5><p>A <code>tf.train.Server</code> object contains</p>
<ul>
<li>a set of local devices, a set of connections to other tasks in its <code>tf.train.ClusterSpec</code>.</li>
<li>a tf.Session that can use these to perform a distributed computation.</li>
</ul>
<p>Each server is a member of a specific named job and has a task index within that job.<br>A server can communicate with any other server in the cluster.</p>
<p>For example, to launch a cluster with two servers running on localhost:2222 and localhost:2223, run the following snippets in two different processes on the local machine:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># In task 0:</span></div><div class="line">cluster = tf.train.ClusterSpec(&#123;<span class="string">"local"</span>: [<span class="string">"localhost:2222"</span>, <span class="string">"localhost:2223"</span>]&#125;)</div><div class="line">server = tf.train.Server(cluster, job_name=<span class="string">"local"</span>, task_index=<span class="number">0</span>)</div><div class="line"></div><div class="line"><span class="comment"># In task 1:</span></div><div class="line">cluster = tf.train.ClusterSpec(&#123;<span class="string">"local"</span>: [<span class="string">"localhost:2222"</span>, <span class="string">"localhost:2223"</span>]&#125;)</div><div class="line">server = tf.train.Server(cluster, job_name=<span class="string">"local"</span>, task_index=<span class="number">1</span>)</div></pre></td></tr></table></figure></p>
<h4 id="Specifying-distributed-devices-in-your-model"><a href="#Specifying-distributed-devices-in-your-model" class="headerlink" title="Specifying distributed devices in your model"></a>Specifying distributed devices in your model</h4><p>To place operations on a particular process, you can use the same tf.device function that is used to specify whether ops run on the CPU or GPU. For example:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">with</span> tf.device(<span class="string">"/job:ps/task:0"</span>):</div><div class="line">  weights_1 = tf.Variable(...)</div><div class="line">  biases_1 = tf.Variable(...)</div><div class="line"></div><div class="line"><span class="keyword">with</span> tf.device(<span class="string">"/job:ps/task:1"</span>):</div><div class="line">  weights_2 = tf.Variable(...)</div><div class="line">  biases_2 = tf.Variable(...)</div><div class="line"></div><div class="line"><span class="keyword">with</span> tf.device(<span class="string">"/job:worker/task:7"</span>):</div><div class="line">  input, labels = ...</div><div class="line">  layer_1 = tf.nn.relu(tf.matmul(input, weights_1) + biases_1)</div><div class="line">  logits = tf.nn.relu(tf.matmul(layer_1, weights_2) + biases_2)</div><div class="line">  <span class="comment"># ...</span></div><div class="line">  train_op = ...</div><div class="line"></div><div class="line"><span class="keyword">with</span> tf.Session(<span class="string">"grpc://worker7.example.com:2222"</span>) <span class="keyword">as</span> sess:</div><div class="line">  <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10000</span>):</div><div class="line">    sess.run(train_op)</div></pre></td></tr></table></figure></p>
<p>In the above example, the variables are created on two tasks in the ps job, and the compute-intensive part of the model is created in the worker job. TensorFlow will insert the appropriate data transfers between the jobs (from ps to worker for the forward pass, and from worker to ps for applying gradients).</p>
<h4 id="Replicated-training"><a href="#Replicated-training" class="headerlink" title="Replicated training"></a>Replicated training</h4><p>A common training configuration, called “data parallelism,” </p>
<ul>
<li>involves <strong>multiple tasks</strong> in a <strong>worker job</strong> training the <strong>same model</strong> on <strong>different mini-batches</strong> of data, </li>
<li>updating shared parameters hosted in one or more tasks in a ps job.</li>
</ul>
<p>There are many ways to specify this structure in TensorFlow, and we are building libraries that will simplify the work of specifying a replicated model.<br>Possible approaches include:</p>
<ul>
<li>In-graph replication.<ul>
<li>In this approach, the client builds a single tf.Graph that contains one set of parameters (in tf.Variable nodes pinned to /job:ps); </li>
<li>and multiple copies of the compute-intensive part of the model, each pinned to a different task in /job:worker.</li>
</ul>
</li>
<li>Between-graph replication.?<ul>
<li>In this approach, there is a separate client for each /job:worker task, typically in the same process as the worker task.</li>
<li>Each client builds a similar graph containing the parameters <ul>
<li>(pinned to /job:ps as before using <code>tf.train.replica_device_setter</code> to map them deterministically to the same tasks)</li>
</ul>
</li>
<li>and a single copy of the compute-intensive part of the model, pinned to the local task in /job:worker.</li>
</ul>
</li>
<li>Asynchronous training.?<ul>
<li>In this approach, each replica of the graph has an independent training loop that executes without coordination. It is compatible with both forms of replication above.</li>
</ul>
</li>
<li>Synchronous training. <ul>
<li>n this approach, all of the replicas read the same values for the current parameters, compute gradients in parallel, and then apply them together.</li>
<li>It is compatible with in-graph replication (e.g. using gradient averaging as in the CIFAR-10 multi-GPU trainer), and between-graph replication (e.g. using the tf.train.SyncReplicasOptimizer).</li>
</ul>
</li>
</ul>
<h5 id="Putting-it-all-together-example-trainer-program"><a href="#Putting-it-all-together-example-trainer-program" class="headerlink" title="Putting it all together: example trainer program"></a>Putting it all together: example trainer program</h5><p>The following code shows the skeleton of a distributed trainer program<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> argparse</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div><div class="line"></div><div class="line">FLAGS = <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(_)</span>:</span></div><div class="line">  ps_hosts = FLAGS.ps_hosts.split(<span class="string">","</span>)</div><div class="line">  worker_hosts = FLAGS.worker_hosts.split(<span class="string">","</span>)</div><div class="line"></div><div class="line">  <span class="comment"># Create a cluster from the parameter server and worker hosts.</span></div><div class="line">  cluster = tf.train.ClusterSpec(&#123;<span class="string">"ps"</span>: ps_hosts, <span class="string">"worker"</span>: worker_hosts&#125;)</div><div class="line"></div><div class="line">  <span class="comment"># Create and start a server for the local task.</span></div><div class="line">  server = tf.train.Server(cluster,</div><div class="line">                           job_name=FLAGS.job_name,</div><div class="line">                           task_index=FLAGS.task_index)</div><div class="line"></div><div class="line">  <span class="keyword">if</span> FLAGS.job_name == <span class="string">"ps"</span>:</div><div class="line">    server.join()</div><div class="line">  <span class="keyword">elif</span> FLAGS.job_name == <span class="string">"worker"</span>:</div><div class="line"></div><div class="line">    <span class="comment"># Assigns ops to the local worker by default.</span></div><div class="line">    <span class="keyword">with</span> tf.device(tf.train.replica_device_setter(</div><div class="line">        worker_device=<span class="string">"/job:worker/task:%d"</span> % FLAGS.task_index,</div><div class="line">        cluster=cluster)):</div><div class="line"></div><div class="line">      <span class="comment"># Build model...</span></div><div class="line">      loss = ...</div><div class="line">      global_step = tf.contrib.framework.get_or_create_global_step()</div><div class="line"></div><div class="line">      train_op = tf.train.AdagradOptimizer(<span class="number">0.01</span>).minimize(</div><div class="line">          loss, global_step=global_step)</div><div class="line"></div><div class="line">    <span class="comment"># The StopAtStepHook handles stopping after running given steps.</span></div><div class="line">    hooks=[tf.train.StopAtStepHook(last_step=<span class="number">1000000</span>)]</div><div class="line"></div><div class="line">    <span class="comment"># The MonitoredTrainingSession takes care of session initialization,</span></div><div class="line">    <span class="comment"># restoring from a checkpoint, saving to a checkpoint, and closing when done</span></div><div class="line">    <span class="comment"># or an error occurs.</span></div><div class="line">    <span class="keyword">with</span> tf.train.MonitoredTrainingSession(master=server.target,</div><div class="line">                                           is_chief=(FLAGS.task_index == <span class="number">0</span>),</div><div class="line">                                           checkpoint_dir=<span class="string">"/tmp/train_logs"</span>,</div><div class="line">                                           hooks=hooks) <span class="keyword">as</span> mon_sess:</div><div class="line">      <span class="keyword">while</span> <span class="keyword">not</span> mon_sess.should_stop():</div><div class="line">        <span class="comment"># Run a training step asynchronously.</span></div><div class="line">        <span class="comment"># See `tf.train.SyncReplicasOptimizer` for additional details on how to</span></div><div class="line">        <span class="comment"># perform *synchronous* training.</span></div><div class="line">        <span class="comment"># mon_sess.run handles AbortedError in case of preempted PS.</span></div><div class="line">        mon_sess.run(train_op)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">  parser = argparse.ArgumentParser()</div><div class="line">  parser.register(<span class="string">"type"</span>, <span class="string">"bool"</span>, <span class="keyword">lambda</span> v: v.lower() == <span class="string">"true"</span>)</div><div class="line">  <span class="comment"># Flags for defining the tf.train.ClusterSpec</span></div><div class="line">  parser.add_argument(</div><div class="line">      <span class="string">"--ps_hosts"</span>,</div><div class="line">      type=str,</div><div class="line">      default=<span class="string">""</span>,</div><div class="line">      help=<span class="string">"Comma-separated list of hostname:port pairs"</span></div><div class="line">  )</div><div class="line">  parser.add_argument(</div><div class="line">      <span class="string">"--worker_hosts"</span>,</div><div class="line">      type=str,</div><div class="line">      default=<span class="string">""</span>,</div><div class="line">      help=<span class="string">"Comma-separated list of hostname:port pairs"</span></div><div class="line">  )</div><div class="line">  parser.add_argument(</div><div class="line">      <span class="string">"--job_name"</span>,</div><div class="line">      type=str,</div><div class="line">      default=<span class="string">""</span>,</div><div class="line">      help=<span class="string">"One of 'ps', 'worker'"</span></div><div class="line">  )</div><div class="line">  <span class="comment"># Flags for defining the tf.train.Server</span></div><div class="line">  parser.add_argument(</div><div class="line">      <span class="string">"--task_index"</span>,</div><div class="line">      type=int,</div><div class="line">      default=<span class="number">0</span>,</div><div class="line">      help=<span class="string">"Index of task within the job"</span></div><div class="line">  )</div><div class="line">  FLAGS, unparsed = parser.parse_known_args()</div><div class="line">  tf.app.run(main=main, argv=[sys.argv[<span class="number">0</span>]] + unparsed)</div></pre></td></tr></table></figure></p>
<h4 id="Glossary"><a href="#Glossary" class="headerlink" title="Glossary"></a>Glossary</h4><h5 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h5><p>A client is typically a program that builds a TensorFlow graph and constructs a tensorflow::Session to interact with a cluster.<br>A single client process can directly interact with multiple TensorFlow servers (see “Replicated training” above), and a single server can serve multiple clients.</p>
<h5 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h5><p>A TensorFlow cluster comprises a one or more “jobs”, each divided into lists of one or more “tasks”.<br>A cluster is typically dedicated to a particular high-level objective, such as training a neural network, using many machines in parallel.<br>A cluster is defined by a tf.train.ClusterSpec object.</p>
<h5 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h5><p>A job comprises a list of “tasks”, which typically serve a common purpose.<br>For example, a job named ps (for “parameter server”) typically hosts nodes that store and update variables<br>while a job named worker typically hosts stateless nodes that perform compute-intensive tasks.<br>The tasks in a job typically run on different machines.<br>The set of job roles is flexible: for example, a worker may maintain some state.</p>
<h5 id="Master-service"><a href="#Master-service" class="headerlink" title="Master service"></a>Master service</h5><p>An RPC service that provides remote access to a set of distributed devices, and acts as a session target.<br>The master service implements the tensorflow::Session interface, and is responsible for coordinating work across one or more “worker services”.<br>All TensorFlow servers implement the master service.</p>
<h5 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h5><p>A task corresponds to a specific TensorFlow server, and typically corresponds to a single process. A task belongs to a particular “job” and is identified by its index within that job’s list of tasks.</p>
<h5 id="TensorFlow-server"><a href="#TensorFlow-server" class="headerlink" title="TensorFlow server"></a>TensorFlow server</h5><p>A process running a tf.train.Server instance, which is a member of a cluster, and exports a “master service” and “worker service”.</p>
<h5 id="Worker-service"><a href="#Worker-service" class="headerlink" title="Worker service"></a>Worker service</h5><p>An RPC service that executes parts of a TensorFlow graph using its local devices. A worker service implements worker_service.proto. All TensorFlow servers implement the worker service.</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/08/19/tf_supervisor/" rel="next" title="">
                <i class="fa fa-chevron-left"></i> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/08/27/tf_train/" rel="prev" title="">
                 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Klpek" />
          <p class="site-author-name" itemprop="name">Klpek</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Easy-demo"><span class="nav-number">1.</span> <span class="nav-text">Easy demo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-a-cluster"><span class="nav-number">2.</span> <span class="nav-text">Create a cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cluster"><span class="nav-number">2.1.</span> <span class="nav-text">cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#task"><span class="nav-number">2.1.0.1.</span> <span class="nav-text">task</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#jobs"><span class="nav-number">2.1.0.2.</span> <span class="nav-text">jobs</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#create-cluster"><span class="nav-number">2.2.</span> <span class="nav-text">create cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Create-a-tf-train-ClusterSpec-to-describe-the-cluster"><span class="nav-number">2.2.1.</span> <span class="nav-text">Create a tf.train.ClusterSpec to describe the cluster</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Create-a-tf-train-Server-instance-in-each-task"><span class="nav-number">2.2.2.</span> <span class="nav-text">Create a tf.train.Server instance in each task</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Specifying-distributed-devices-in-your-model"><span class="nav-number">2.3.</span> <span class="nav-text">Specifying distributed devices in your model</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Replicated-training"><span class="nav-number">2.4.</span> <span class="nav-text">Replicated training</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Putting-it-all-together-example-trainer-program"><span class="nav-number">2.4.1.</span> <span class="nav-text">Putting it all together: example trainer program</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Glossary"><span class="nav-number">2.5.</span> <span class="nav-text">Glossary</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Client"><span class="nav-number">2.5.1.</span> <span class="nav-text">Client</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Cluster"><span class="nav-number">2.5.2.</span> <span class="nav-text">Cluster</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Job"><span class="nav-number">2.5.3.</span> <span class="nav-text">Job</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Master-service"><span class="nav-number">2.5.4.</span> <span class="nav-text">Master service</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Task"><span class="nav-number">2.5.5.</span> <span class="nav-text">Task</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TensorFlow-server"><span class="nav-number">2.5.6.</span> <span class="nav-text">TensorFlow server</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Worker-service"><span class="nav-number">2.5.7.</span> <span class="nav-text">Worker service</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Powered By Klpek</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="#">Klpek</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="#">
    Ekon
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'klpek';
      var disqus_identifier = '2017/08/23/tf_distributed/';

      var disqus_title = "";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      

    </script>
  













  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->





  

  

  
  


  

</body>
</html>
